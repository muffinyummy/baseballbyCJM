<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì•¼êµ¬ ê²Œì„ ê°œì¸ ìŠ¤ì½”ì–´ë³´ë“œ (ERA & WHIP í¬í•¨)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #e5e7eb;
      color: #111827;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 24px 12px;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
      padding: 20px 18px 24px;
      border: 1px solid #d1d5db;
    }

    h1 { margin: 0 0 6px; text-align: center; font-size: 1.5rem; color: #111827; }
    .subtitle { text-align: center; font-size: 0.9rem; color: #6b7280; margin-bottom: 14px; }

    .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 10px; }
    .field { display: flex; flex-direction: column; gap: 4px; font-size: 0.85rem; }
    .field label { color: #4b5563; font-weight: 500; }
    .field input, .field select { padding: 6px 8px; border-radius: 8px; border: 1px solid #d1d5db; background: #ffffff; color: #111827; font-size: 0.9rem; }
    .field input:focus, .field select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 1px rgba(37,99,235,0.2); }

    .player-names { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; margin-bottom: 8px; }
    .current-inning { margin: 4px 0 10px; font-size: 0.9rem; text-align: center; color: #b45309; font-weight: 600; }
    .buttons-row { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:14px; }

    button { border:none; border-radius:999px; padding:8px 14px; font-size:0.85rem; cursor:pointer; background:#f3f4f6; color:#111827; transition: transform .05s, box-shadow .1s, background .1s; display:inline-flex; align-items:center; gap:4px; border:1px solid #d1d5db; }
    button.primary { background:#2563eb; border-color:#2563eb; color:#fff; }
    button.danger { background:#dc2626; border-color:#dc2626; color:#fff; }
    button.small { padding:4px 10px; font-size:0.78rem; }

    button:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(15,23,42,0.15); background:#e5e7eb; }
    button.primary:hover { background:#1d4ed8; } button.danger:hover { background:#b91c1c; } button:active { transform: translateY(0); box-shadow:none; }

    .table-wrapper { overflow-x:auto; border-radius:12px; border:1px solid #d1d5db; background:#ffffff; margin-bottom:12px; }
    table { width:100%; border-collapse:collapse; font-size:0.82rem; min-width:500px; }
    thead { background:#f3f4f6; border-bottom:2px solid #e5e7eb; }
    th, td { padding:6px 8px; text-align:center; border-bottom:1px solid #e5e7eb; }
    th { font-weight:600; color:#4b5563; white-space:nowrap; }
    tbody tr:nth-child(odd) { background:#ffffff; } tbody tr:nth-child(even) { background:#f9fafb; }

    td.player-name { text-align:left; padding-left:10px; font-weight:600; color:#111827; }
    td.current-inning-cell { background:#fee2e2; }

    td input.run-cell { width:40px; text-align:center; border-radius:6px; border:1px solid #d1d5db; background:#fff; color:#111827; font-size:0.8rem; padding:3px 4px; }
    td input.run-cell:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 1px rgba(37,99,235,0.2); }

    td input.stat-cell, td input.detail-cell, td input.pitcher-input, td input.batter-name-input { width:100%; border-radius:6px; border:1px solid #d1d5db; background:#fff; color:#111827; font-size:0.8rem; padding:3px 4px; }
    td input.stat-cell:focus, td input.detail-cell:focus, td input.pitcher-input:focus, td input.batter-name-input:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 1px rgba(37,99,235,0.2); }

    .section-title { margin:16px 2px 4px; font-size:1rem; font-weight:700; color:#111827; border-left:4px solid #f97316; padding-left:8px; }
    .section-sub { margin:0 2px 6px; font-size:0.78rem; color:#6b7280; }

    .team-total-row { background: #e5e7eb !important; font-weight:700; }
    .footer-info { margin-top:8px; text-align:right; font-size:0.75rem; color:#9ca3af; }

    @media (max-width:600px) { .app { padding:14px 10px 18px; border-radius:12px; } h1 { font-size:1.25rem; } table { font-size:0.78rem; min-width:420px; } }
  </style>
</head>
<body>
  <div class="app">
    <h1>ê°œì¸ ì•¼êµ¬ê²Œì„ ìŠ¤ì½”ì–´ë³´ë“œ</h1>
    <div class="subtitle">íˆ¬ìˆ˜ ERA / WHIP ìë™ê³„ì‚° í¬í•¨ âš¾</div>

    <div class="controls">
      <div class="field">
        <label for="playersSelect">íŒ€(ì„ ìˆ˜) ìˆ˜</label>
        <select id="playersSelect">
          <option value="3" selected>3ëª…</option>
          <option value="4">4ëª…</option>
          <option value="5">5ëª…</option>
          <option value="6">6ëª…</option>
        </select>
      </div>
      <div class="field">
        <label for="inningsSelect">ì´ë‹ ìˆ˜</label>
        <select id="inningsSelect">
          <option value="1">1 ì´ë‹</option>
          <option value="2">2 ì´ë‹</option>
          <option value="3">3 ì´ë‹</option>
          <option value="4">4 ì´ë‹</option>
          <option value="5">5 ì´ë‹</option>
          <option value="6">6 ì´ë‹</option>
          <option value="7">7 ì´ë‹</option>
          <option value="8">8 ì´ë‹</option>
          <option value="9" selected>9 ì´ë‹</option>
        </select>
      </div>
    </div>

    <div id="playerNamesContainer" class="player-names"></div>

    <div class="current-inning" id="currentInningLabel">í˜„ì¬ ì´ë‹: 1íšŒ</div>
    <div class="buttons-row" id="buttonsRow"></div>

    <div class="table-wrapper">
      <table>
        <thead id="scoreHeader"></thead>
        <tbody id="scoreBody"></tbody>
      </table>
    </div>

    <div class="batter-section">
      <div class="section-title">íƒ€ì ê¸°ë¡í‘œ</div>
      <div class="section-sub">
        AB/H/BB/TB ê¸°ë°˜ìœ¼ë¡œ AVG / OBP / SLG / OPS ìë™ ê³„ì‚°
      </div>
      <div class="controls" style="margin-bottom:6px;">
        <div class="field">
          <label for="batterTeamSelect">ê¸°ë¡ì§€ íŒ€(ì„ ìˆ˜) ì„ íƒ</label>
          <select id="batterTeamSelect"></select>
        </div>
        <div class="field">
          <label for="lineupSizeSelect">ë¼ì¸ì—… ì¸ì› ìˆ˜</label>
          <select id="lineupSizeSelect">
            <option value="4" selected>4ëª…</option>
            <option value="5">5ëª…</option>
            <option value="6">6ëª…</option>
            <option value="7">7ëª…</option>
            <option value="8">8ëª…</option>
            <option value="9">9ëª…</option>
          </select>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead id="batterTableHead"></thead>
          <tbody id="batterTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="pitcher-section">
      <div class="section-title">íˆ¬ìˆ˜ ê¸°ë¡í‘œ (ERA / WHIP ìë™ê³„ì‚°)</div>
      <div class="section-sub">
        ì´ë‹ í‘œê¸°: 5.1 = 5ì™€ 1ì•„ì›ƒ(=5â…“), 5.2 = 5ì™€ 2ì•„ì›ƒ(=5â…”). ERA = (ìì±…ì *9)/IP, WHIP = (í”¼ì•ˆíƒ€+ë³¼ë„·)/IP
      </div>

      <div class="controls" style="margin-bottom:6px;">
        <div class="field">
          <label for="pitcherTeamSelect">íˆ¬ìˆ˜ ê¸°ë¡ì§€ íŒ€ ì„ íƒ</label>
          <select id="pitcherTeamSelect"></select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="addPitcherBtn" class="primary">íˆ¬ìˆ˜ ì¶”ê°€</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>íˆ¬ìˆ˜ëª…</th>
              <th>ì´ë‹(IP)</th>
              <th>í”¼ì•ˆíƒ€</th>
              <th>ì‹¤ì </th>
              <th>ìì±…(ER)</th>
              <th>ë³¼ë„·(BB)</th>
              <th>ì‚¼ì§„</th>
              <th>í”¼í™ˆëŸ°</th>
              <th>íˆ¬êµ¬ìˆ˜</th>
              <th>ERA</th>
              <th>WHIP</th>
              <th>ê´€ë¦¬</th>
            </tr>
          </thead>
          <tbody id="pitcherTableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="buttons-row" style="justify-content:flex-end; margin-top:4px; gap:6px;">
      <button id="saveGameBtn">í˜„ì¬ ê¸°ë¡ ì €ì¥(ë¸Œë¼ìš°ì €)</button>
      <button id="loadGameBtn">ë¸Œë¼ìš°ì €ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <div class="buttons-row" style="justify-content:flex-end; margin-top:4px; gap:6px;">
      <button id="exportJsonBtn">JSON íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°</button>
      <button id="importJsonBtn">JSON íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <input type="file" id="importJsonInput" accept="application/json" style="display:none;" />
    </div>

    <div class="footer-info">ì ìˆ˜/ê¸°ë¡ ì¹¸ì€ ì „ë¶€ ì§ì ‘ ìˆ˜ì • ê°€ëŠ¥. ì €ì¥ì€ ë¸Œë¼ìš°ì €/JSON íŒŒì¼.</div>
  </div>

  <script>
    // DOM
    const inningsSelect = document.getElementById("inningsSelect");
    const playersSelect = document.getElementById("playersSelect");
    const currentInningLabel = document.getElementById("currentInningLabel");
    const scoreHeader = document.getElementById("scoreHeader");
    const scoreBody = document.getElementById("scoreBody");
    const playerNamesContainer = document.getElementById("playerNamesContainer");
    const buttonsRow = document.getElementById("buttonsRow");

    const batterTableHead = document.getElementById("batterTableHead");
    const batterTableBody = document.getElementById("batterTableBody");
    const batterTeamSelect = document.getElementById("batterTeamSelect");
    const lineupSizeSelect = document.getElementById("lineupSizeSelect");

    const pitcherTeamSelect = document.getElementById("pitcherTeamSelect");
    const pitcherTableBody = document.getElementById("pitcherTableBody");
    const addPitcherBtn = document.getElementById("addPitcherBtn");

    const saveGameBtn = document.getElementById("saveGameBtn");
    const loadGameBtn = document.getElementById("loadGameBtn");
    const exportJsonBtn = document.getElementById("exportJsonBtn");
    const importJsonBtn = document.getElementById("importJsonBtn");
    const importJsonInput = document.getElementById("importJsonInput");

    // state
    let innings = parseInt(inningsSelect.value, 10);
    let players = parseInt(playersSelect.value, 10);
    let currentInning = 1;
    let scores = createEmptyScores(players, innings);

    let lineupSize = parseInt(lineupSizeSelect.value, 10);
    let currentBatterTeam = 0;
    let batterStats = [];

    let pitcherStats = [];
    let currentPitcherTeam = 0;

    const STORAGE_KEY = "personalBaseballScoreboardState_v2";

    function createEmptyScores(p, inn) {
      return Array.from({ length: p }, () => new Array(inn).fill(0));
    }

    function createDefaultBatterRow() {
      return { name: "", ab:0, r:0, h:0, rbi:0, hr:0, so:0, sb:0, bb:0, tb:0, inningResults: new Array(innings).fill("") };
    }

    function initBatterStatsForTeams() {
      batterStats = [];
      for (let t=0; t<players; t++) {
        const rows = [];
        for (let i=0;i<lineupSize;i++) rows.push(createDefaultBatterRow());
        batterStats.push(rows);
      }
    }

    function initPitcherStatsForTeams() {
      pitcherStats = [];
      for (let t=0; t<players; t++) pitcherStats.push([]);
    }

    /** ---------------- SCOREBOARD ---------------- */
    function renderHeader() {
      let html = "<tr><th>íŒ€(ì„ ìˆ˜)</th>";
      for (let i=1;i<=innings;i++) html += `<th>${i}</th>`;
      html += "<th>í•©ê³„</th></tr>";
      scoreHeader.innerHTML = html;
    }

    function getPlayerNames() {
      const inputs = playerNamesContainer.querySelectorAll(".player-name-input");
      const arr = [];
      for (let i=0;i<players;i++){
        const input = Array.from(inputs).find(el => parseInt(el.dataset.player,10)===i);
        arr.push(input && input.value.trim() ? input.value.trim() : `íŒ€ ${i+1}`);
      }
      return arr;
    }

    function getTotal(teamIndex) {
      return scores[teamIndex].reduce((s,v)=> s + (Number(v)||0), 0);
    }

    function renderBody() {
      const teamNames = getPlayerNames();
      let bodyHtml = "";
      for (let t=0;t<players;t++){
        bodyHtml += "<tr>";
        bodyHtml += `<td class="player-name">${teamNames[t]}</td>`;
        for (let i=0;i<innings;i++){
          const isCurrent = (i+1===currentInning);
          const cls = isCurrent ? "current-inning-cell" : "";
          const value = scores[t][i] ?? 0;
          bodyHtml += `<td class="${cls}"><input class="run-cell" type="number" min="0" data-team="${t}" data-inning="${i}" value="${value}"></td>`;
        }
        bodyHtml += `<td>${getTotal(t)}</td>`;
        bodyHtml += "</tr>";
      }
      scoreBody.innerHTML = bodyHtml;

      const inputs = scoreBody.querySelectorAll("input.run-cell");
      inputs.forEach(input=>{
        input.addEventListener("input", (e)=>{
          const tm = parseInt(e.target.dataset.team,10);
          const inn = parseInt(e.target.dataset.inning,10);
          const val = parseInt(e.target.value,10);
          scores[tm][inn] = isNaN(val) ? 0 : val;
          renderBody();
        });
      });
    }

    function updateCurrentInningLabel(){ currentInningLabel.textContent = `í˜„ì¬ ì´ë‹: ${currentInning}íšŒ`; }

    function renderPlayerNameInputs(){
      let html = "";
      for (let i=0;i<players;i++){
        html += `<div class="field"><label>íŒ€(ì„ ìˆ˜) ${i+1} ì´ë¦„</label><input type="text" class="player-name-input" data-player="${i}" value="íŒ€ ${i+1}" /></div>`;
      }
      playerNamesContainer.innerHTML = html;
      const nameInputs = playerNamesContainer.querySelectorAll(".player-name-input");
      nameInputs.forEach(inp => inp.addEventListener("input", () => {
        renderBody(); renderButtons(); renderBatterTeamSelect(); renderBatterTable(); renderPitcherTeamSelect(); renderPitcherTable();
      }));
    }

    function renderButtons(){
      const names = getPlayerNames();
      let html = "";
      for (let i=0;i<players;i++){
        const label = (names[i]||`íŒ€ ${i+1}`) + " +1ì ";
        html += `<button class="primary team-btn" data-team="${i}">${label}</button>`;
      }
      html += `<button id="nextInning">ë‹¤ìŒ ì´ë‹</button>`;
      html += `<button class="danger" id="resetGame">ì „ì²´ ì´ˆê¸°í™”</button>`;
      buttonsRow.innerHTML = html;

      buttonsRow.querySelectorAll(".team-btn").forEach(btn=>{
        btn.addEventListener("click", e=>{
          const tm = parseInt(e.target.dataset.team,10);
          if (currentInning > innings) return;
          scores[tm][currentInning-1] += 1;
          renderBody();
        });
      });
      document.getElementById("nextInning").addEventListener("click", ()=>{
        if (currentInning < innings) { currentInning++; updateCurrentInningLabel(); renderBody(); }
        else alert("ë§ˆì§€ë§‰ ì´ë‹ì…ë‹ˆë‹¤! ğŸ˜„");
      });
      document.getElementById("resetGame").addEventListener("click", ()=>{
        if (!confirm("ëª¨ë“  ì ìˆ˜ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
        scores = createEmptyScores(players, innings);
        initBatterStatsForTeams();
        initPitcherStatsForTeams();
        currentInning = 1;
        updateCurrentInningLabel();
        renderHeader(); renderBody(); renderButtons(); renderBatterTeamSelect(); renderBatterTable(); renderPitcherTeamSelect(); renderPitcherTable();
      });
    }

    /** ---------------- BATTER ---------------- */
    function renderBatterTeamSelect(){
      const names = getPlayerNames();
      let opts = "";
      for (let t=0;t<players;t++){
        const sel = t===currentBatterTeam ? "selected" : "";
        opts += `<option value="${t}" ${sel}>${names[t]||`íŒ€ ${t+1}`}</option>`;
      }
      batterTeamSelect.innerHTML = opts;
    }

    function renderBatterHeader(){
      let h = "<tr>";
      h += "<th>íƒ€ìˆœ</th><th>íƒ€ìëª…</th><th>íƒ€ìˆ˜</th><th>ë“ì </th><th>ì•ˆíƒ€</th><th>íƒ€ì </th><th>í™ˆëŸ°</th><th>ì‚¼ì§„</th><th>ë„ë£¨</th><th>ë³¼ë„·</th><th>ë£¨íƒ€</th><th>íƒ€ìœ¨</th><th>ì¶œë£¨ìœ¨</th><th>ì¥íƒ€ìœ¨</th><th>OPS</th>";
      for (let i=1;i<=innings;i++) h += `<th>${i}</th>`;
      h += "</tr>";
      batterTableHead.innerHTML = h;
    }

    function computeRates(ab, h, bb, tb){
      ab = Number(ab) || 0; h = Number(h) || 0; bb = Number(bb) || 0; tb = Number(tb) || 0;
      let avgStr = "-", obpStr = "-", slgStr = "-", opsStr = "-";
      let avgNum = null, obpNum = null, slgNum = null;
      if (ab > 0) { avgNum = h/ab; slgNum = tb/ab; }
      if (ab + bb > 0) { obpNum = (h + bb) / (ab + bb); }
      if (avgNum !== null) avgStr = avgNum.toFixed(3);
      if (obpNum !== null) obpStr = obpNum.toFixed(3);
      if (slgNum !== null) slgStr = slgNum.toFixed(3);
      if (obpNum !== null && slgNum !== null) opsStr = (obpNum + slgNum).toFixed(3);
      return { avgStr, obpStr, slgStr, opsStr, avgNum, obpNum, slgNum };
    }

    function renderBatterTable(){
      renderBatterHeader();
      if (!batterStats[currentBatterTeam]) return;
      const teamNames = getPlayerNames();
      const teamName = teamNames[currentBatterTeam] || `íŒ€ ${currentBatterTeam+1}`;
      const rows = batterStats[currentBatterTeam];
      let body = "";

      // team totals
      let totalAB=0,totalR=0,totalH=0,totalRBI=0,totalHR=0,totalSO=0,totalSB=0,totalBB=0,totalTB=0;

      for (let i=0;i<lineupSize;i++){
        const row = rows[i] || createDefaultBatterRow();
        rows[i] = row;
        let name = row.name || (i===0 ? teamName : teamName + i);
        const ab = Number(row.ab) || 0;
        const r = Number(row.r) || 0;
        const h = Number(row.h) || 0;
        const rbi = Number(row.rbi) || 0;
        const hr = Number(row.hr) || 0;
        const so = Number(row.so) || 0;
        const sb = Number(row.sb) || 0;
        const bb = Number(row.bb) || 0;
        const tb = Number(row.tb) || 0;

        totalAB+=ab; totalR+=r; totalH+=h; totalRBI+=rbi; totalHR+=hr; totalSO+=so; totalSB+=sb; totalBB+=bb; totalTB+=tb;

        const { avgStr, obpStr, slgStr, opsStr } = computeRates(ab,h,bb,tb);

        body += "<tr>";
        body += `<td>${i+1}</td>`;
        body += `<td><input type="text" class="batter-name-input" data-index="${i}" value="${name}"></td>`;
        body += `<td><input type="number" min="0" class="stat-cell" data-index="${i}" data-field="ab" value="${row.ab ?? 0}"></td>`;
        body += `<td><input type="number" min="0" class="stat-cell" data-index="${i}" data-field="r" value="${row.r ?? 0}"></td>`;
        body += `<td><input type="number" min="0" class="stat-cell" data-index="${i}" data-field="h" value="${row.h ?? 0}"></td>`;
        body += `<td><input type="number" min="0" class="stat-cell" data-index="${i}" data-field="rbi" value="${row.rbi ?? 0}"></td>`;
        body += `<td><input type="number" min="0" class="stat-cell" data-index="${i}" data-field="hr" value="${row.hr ?? 0}"></td>`;
        body += `<td><input type="number" min="0" class="stat-cell" data-index="${i}" data-field="so" value="${row.so ?? 0}"></td>`;
        body += `<td><input type="number" min="0" class="stat-cell" data-index="${i}" data-field="sb" value="${row.sb ?? 0}"></td>`;
        body += `<td><input type="number" min="0" class="stat-cell" data-index="${i}" data-field="bb" value="${row.bb ?? 0}"></td>`;
        body += `<td><input type="number" min="0" class="stat-cell" data-index="${i}" data-field="tb" value="${row.tb ?? 0}"></td>`;
        body += `<td>${avgStr}</td><td>${obpStr}</td><td>${slgStr}</td><td>${opsStr}</td>`;

        for (let inn=0; inn<innings; inn++){
          const val = row.inningResults[inn] || "";
          body += `<td><input type="text" class="detail-cell" data-index="${i}" data-inning="${inn}" value="${val}"></td>`;
        }
        body += "</tr>";
      }

      // team totals row
      const teamRates = computeRates(totalAB, totalH, totalBB, totalTB);
      body += `<tr class="team-total-row">`;
      body += `<td colspan="2">íŒ€ í•©ê³„</td>`;
      body += `<td>${totalAB}</td><td>${totalR}</td><td>${totalH}</td><td>${totalRBI}</td><td>${totalHR}</td><td>${totalSO}</td><td>${totalSB}</td><td>${totalBB}</td><td>${totalTB}</td>`;
      body += `<td>${teamRates.avgStr}</td><td>${teamRates.obpStr}</td><td>${teamRates.slgStr}</td><td>${teamRates.opsStr}</td>`;
      for (let inn=0; inn<innings; inn++) body += `<td>-</td>`;
      body += `</tr>`;

      batterTableBody.innerHTML = body;

      // listeners
      batterTableBody.querySelectorAll("input.batter-name-input").forEach(inp=>{
        inp.addEventListener("input", e=>{
          const idx = parseInt(e.target.dataset.index,10);
          batterStats[currentBatterTeam][idx].name = e.target.value;
        });
      });
      batterTableBody.querySelectorAll("input.stat-cell").forEach(inp=>{
        inp.addEventListener("input", e=>{
          const idx = parseInt(e.target.dataset.index,10);
          const field = e.target.dataset.field;
          const val = parseInt(e.target.value,10);
          batterStats[currentBatterTeam][idx][field] = isNaN(val) ? 0 : val;
          renderBatterTable(); // recalc rates + team totals
        });
      });
      batterTableBody.querySelectorAll("input.detail-cell").forEach(inp=>{
        inp.addEventListener("input", e=>{
          const idx = parseInt(e.target.dataset.index,10);
          const inn = parseInt(e.target.dataset.inning,10);
          batterStats[currentBatterTeam][idx].inningResults[inn] = e.target.value;
        });
      });
    }

    function resizeLineup(newSize){
      lineupSize = newSize;
      for (let t=0;t<players;t++){
        const rows = batterStats[t] || [];
        if (rows.length < newSize) for (let i=rows.length;i<newSize;i++) rows.push(createDefaultBatterRow());
        else rows.length = newSize;
        batterStats[t] = rows;
      }
      renderBatterTable();
    }

    function resetForInningChange(){
      scores = createEmptyScores(players, innings);
      for (let t=0;t<players;t++){
        const rows = batterStats[t] || [];
        rows.forEach(row=>{
          const oldArr = row.inningResults || [];
          const newArr = new Array(innings).fill("");
          const minLen = Math.min(oldArr.length, newArr.length);
          for (let i=0;i<minLen;i++) newArr[i] = oldArr[i];
          row.inningResults = newArr;
        });
        batterStats[t] = rows;
      }
      currentInning = 1;
      updateCurrentInningLabel();
      renderHeader(); renderBody(); renderButtons(); renderBatterTable();
    }

    /** ---------------- PITCHER (ERA / WHIP) ---------------- */
    function renderPitcherTeamSelect(){
      const names = getPlayerNames();
      let opts = "";
      for (let t=0;t<players;t++){
        const sel = t===currentPitcherTeam ? "selected" : "";
        opts += `<option value="${t}" ${sel}>${names[t]||`íŒ€ ${t+1}`}</option>`;
      }
      pitcherTeamSelect.innerHTML = opts;
    }

    // inning string -> numeric innings (e.g., "5.1" => 5 + 1/3)
    function parseInnings(innStr){
      if (innStr === null || innStr === undefined) return 0;
      const s = String(innStr).trim();
      if (s.length === 0) return 0;
      if (!s.includes(".")) {
        const n = Number(s);
        return isNaN(n) ? 0 : n;
      }
      const parts = s.split(".");
      const whole = Number(parts[0]) || 0;
      const frac = parts[1] === undefined ? 0 : parts[1];
      // if fractional is single digit 0/1/2 -> treat as outs (1->1 out, 2->2 outs)
      if (/^[0-9]+$/.test(frac) && frac.length === 1 && (frac === "0" || frac === "1" || frac === "2")) {
        const outs = Number(frac);
        return whole + (outs / 3);
      }
      // otherwise try parse decimal directly
      const asNum = Number(s);
      return isNaN(asNum) ? 0 : asNum;
    }

    function computePitcherERA(er, ip){
      const ER = Number(er) || 0;
      const IP = Number(ip) || 0;
      if (IP <= 0) return "-";
      return ((ER * 9) / IP).toFixed(2);
    }

    function computePitcherWHIP(hits, bb, ip){
      const H = Number(hits) || 0;
      const BB = Number(bb) || 0;
      const IP = Number(ip) || 0;
      if (IP <= 0) return "-";
      return ((H + BB) / IP).toFixed(2);
    }

    function renderPitcherTable(){
      const team = currentPitcherTeam;
      const rows = pitcherStats[team] || [];
      let html = "";

      // team accumulators
      let teamIP = 0, teamER = 0, teamH = 0, teamBB = 0;

      rows.forEach((p, idx) => {
        const ipNumeric = parseInnings(p.inn);
        const er = Number(p.er) || 0;
        const h = Number(p.h) || 0;
        const bb = Number(p.bb) || 0;

        teamIP += ipNumeric;
        teamER += er;
        teamH += h;
        teamBB += bb;

        const eraStr = ipNumeric > 0 ? computePitcherERA(er, ipNumeric) : "-";
        const whipStr = ipNumeric > 0 ? computePitcherWHIP(h, bb, ipNumeric) : "-";

        html += `
          <tr>
            <td><input class="pitcher-input" data-idx="${idx}" data-field="name" value="${p.name}" /></td>
            <td><input class="pitcher-input" data-idx="${idx}" data-field="inn" value="${p.inn}" /></td>
            <td><input class="pitcher-input" type="number" min="0" data-idx="${idx}" data-field="h" value="${p.h}" /></td>
            <td><input class="pitcher-input" type="number" min="0" data-idx="${idx}" data-field="r" value="${p.r}" /></td>
            <td><input class="pitcher-input" type="number" min="0" data-idx="${idx}" data-field="er" value="${p.er}" /></td>
            <td><input class="pitcher-input" type="number" min="0" data-idx="${idx}" data-field="bb" value="${p.bb}" /></td>
            <td><input class="pitcher-input" type="number" min="0" data-idx="${idx}" data-field="so" value="${p.so}" /></td>
            <td><input class="pitcher-input" type="number" min="0" data-idx="${idx}" data-field="hr" value="${p.hr}" /></td>
            <td><input class="pitcher-input" type="number" min="0" data-idx="${idx}" data-field="pit" value="${p.pit}" /></td>
            <td>${eraStr}</td>
            <td>${whipStr}</td>
            <td><button class="danger small delPitcherBtn" data-idx="${idx}">ì‚­ì œ</button></td>
          </tr>
        `;
      });

      // team totals row (ERA and WHIP aggregated)
      const teamERA = teamIP > 0 ? ((teamER * 9) / teamIP).toFixed(2) : "-";
      const teamWHIP = teamIP > 0 ? ((teamH + teamBB) / teamIP).toFixed(2) : "-";

      if (rows.length > 0) {
        html += `<tr class="team-total-row">`;
        html += `<td colspan="2">íŒ€ í•©ê³„</td>`;
        html += `<td>${teamH}</td>`; // í”¼ì•ˆíƒ€
        html += `<td>-</td>`; // ì‹¤ì  (í•©ê³„ R could be shown but we didn't accumulate it here)
        html += `<td>${teamER}</td>`; // ìì±…
        html += `<td>${teamBB}</td>`; // ë³¼ë„·
        html += `<td>-</td><td>-</td><td>${teamIP.toFixed(1)}</td>`; // íˆ¬êµ¬ìˆ˜ ì¹¸ ëŒ€ì‹  IP(ì†Œìˆ˜í‘œí˜„)
        html += `<td>${teamERA}</td><td>${teamWHIP}</td><td>-</td>`;
        html += `</tr>`;
      } else {
        // ì•„ë¬´ íˆ¬ìˆ˜ë„ ì—†ìœ¼ë©´ ë¹ˆ ë°”ë”” í—ˆìš©
      }

      pitcherTableBody.innerHTML = html;

      // attach listeners after innerHTML set
      pitcherTableBody.querySelectorAll(".pitcher-input").forEach(inp=>{
        inp.addEventListener("input", (e)=>{
          const idx = parseInt(e.target.dataset.idx,10);
          const field = e.target.dataset.field;
          const value = e.target.type === "number"
            ? (isNaN(parseInt(e.target.value,10)) ? 0 : parseInt(e.target.value,10))
            : e.target.value;
          pitcherStats[team][idx][field] = value;
          // re-render to update ERA/WHIP and team totals
          renderPitcherTable();
        });
      });

      pitcherTableBody.querySelectorAll(".delPitcherBtn").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          const idx = parseInt(e.target.dataset.idx,10);
          pitcherStats[team].splice(idx,1);
          renderPitcherTable();
        });
      });
    }

    addPitcherBtn.addEventListener("click", ()=>{
      pitcherStats[currentPitcherTeam].push({ name:"", inn:"", h:0, r:0, er:0, bb:0, so:0, hr:0, pit:0 });
      renderPitcherTable();
    });

    pitcherTeamSelect.addEventListener("change", ()=>{
      currentPitcherTeam = parseInt(pitcherTeamSelect.value,10);
      renderPitcherTable();
    });

    /** ---------------- Storage / JSON ---------------- */
    function saveGame(){
      const state = { innings, players, currentInning, lineupSize, scores, batterStats, pitcherStats, playerNames: getPlayerNames(), currentBatterTeam, currentPitcherTeam };
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); alert("í˜„ì¬ ê¸°ë¡ì„ ì €ì¥í–ˆì–´ìš”!"); }
      catch(e) { alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ"); }
    }

    function applyLoadedState(state){
      innings = state.innings || innings;
      players = state.players || players;
      currentInning = state.currentInning || 1;
      lineupSize = state.lineupSize || lineupSize;
      scores = state.scores || createEmptyScores(players, innings);
      batterStats = state.batterStats || [];
      pitcherStats = state.pitcherStats || [];
      const savedNames = state.playerNames || [];
      currentBatterTeam = Math.min(state.currentBatterTeam ?? 0, players-1);
      currentPitcherTeam = Math.min(state.currentPitcherTeam ?? 0, players-1);

      inningsSelect.value = String(innings);
      playersSelect.value = String(players);
      lineupSizeSelect.value = String(lineupSize);

      renderHeader();
      renderPlayerNameInputs();

      const nameInputs = playerNamesContainer.querySelectorAll(".player-name-input");
      savedNames.forEach((nm,i)=> {
        const inp = Array.from(nameInputs).find(el => parseInt(el.dataset.player,10)===i);
        if (inp && nm) inp.value = nm;
      });

      renderBody(); renderButtons(); renderBatterTeamSelect(); renderBatterTable(); renderPitcherTeamSelect(); renderPitcherTable(); updateCurrentInningLabel();
    }

    function loadGame(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) { alert("ì €ì¥ëœ ê¸°ë¡ì´ ì—†ì–´ìš”."); return; }
      try { const state = JSON.parse(raw); applyLoadedState(state); alert("ë¶ˆëŸ¬ì™”ì–´ìš”."); }
      catch(e){ alert("ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜"); }
    }

    saveGameBtn.addEventListener("click", saveGame);
    loadGameBtn.addEventListener("click", loadGame);

    exportJsonBtn.addEventListener("click", ()=>{
      const state = { innings, players, currentInning, lineupSize, scores, batterStats, pitcherStats, playerNames: getPlayerNames(), currentBatterTeam, currentPitcherTeam };
      const json = JSON.stringify(state, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const now = new Date();
      const stamp = now.toISOString().slice(0,19).replace(/[:T]/g,"-");
      a.download = `scoreboard-${stamp}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    importJsonBtn.addEventListener("click", ()=> { importJsonInput.value = ""; importJsonInput.click(); });
    importJsonInput.addEventListener("change", (e)=>{
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = ()=> {
        try { const state = JSON.parse(reader.result); applyLoadedState(state); alert("JSONì—ì„œ ë¶ˆëŸ¬ì™”ì–´ìš”."); }
        catch(err){ alert("JSON ì½ëŠ” ì¤‘ ì˜¤ë¥˜"); }
      };
      reader.readAsText(file, "utf-8");
    });

    /** ---------------- events ---------------- */
    inningsSelect.addEventListener("change", ()=>{
      innings = parseInt(inningsSelect.value,10);
      resetForInningChange();
    });

    playersSelect.addEventListener("change", ()=>{
      players = parseInt(playersSelect.value,10);
      scores = createEmptyScores(players, innings);
      currentInning = 1;
      updateCurrentInningLabel();
      renderHeader(); renderPlayerNameInputs(); renderBody();
      initBatterStatsForTeams(); initPitcherStatsForTeams();
      currentBatterTeam = 0; currentPitcherTeam = 0;
      renderButtons(); renderBatterTeamSelect(); renderBatterTable(); renderPitcherTeamSelect(); renderPitcherTable();
    });

    batterTeamSelect.addEventListener("change", ()=> { currentBatterTeam = parseInt(batterTeamSelect.value,10); renderBatterTable(); });
    lineupSizeSelect.addEventListener("change", ()=> { const newSize = parseInt(lineupSizeSelect.value,10); resizeLineup(newSize); });

    // initial render
    renderHeader(); renderPlayerNameInputs(); renderBody();
    initBatterStatsForTeams(); initPitcherStatsForTeams();
    renderButtons(); renderBatterTeamSelect(); renderBatterTable(); renderPitcherTeamSelect(); renderPitcherTable(); updateCurrentInningLabel();
  </script>
</body>
</html>
